{% extends 'base.html' %}

{% block title %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css')}}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/hero-section.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/progress-bar.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/edu-section.css')}}">
{% endblock %}

{% block body %}
<!-- Progress Section -->
{% include 'components/progress-bar.html' %}
<!--End of Progress Section -->


<section id="edu-section" class="resume-section">
    <div id="edu-content">
        <h1>Awesome! Now, what qualifications do you have?</h1>
        <div class="section-suggestion">
            <i class="fas fa-star"></i>
            <span class="suggestion">We suggest starting with your most recent period of education and working
                backward.</span>
        </div>

        <div id="edu-forms-container">
            <div class="edu-form-wrapper">
                <form class="edu-form">
                    <div>
                        <label for="degree">Degree</label>
                        <input type="text" name="degree" required>
                    </div>

                    <div>
                        <label for="school">Name of School/University</label>
                        <input type="text" name="school" required>
                    </div>
                    <div class="location-div">
                        <label for="location">Location</label>
                        <input type="text" name="location" required>
                    </div>
                    <div class="date-div">
                        <div>
                            <label for="start-date">Start Date</label>
                            <input type="date" name="start-date" required>
                        </div>

                        <div>
                            <label for="end-date">End Date</label>
                            <input type="date" name="end-date">
                        </div>

                        <input type="checkbox" name="is-working">
                        <label for="is-working">I haven't graduated</label>
                    </div>

                </form>
            </div>
            <!-- Add Another Button -->

        </div>
        <div class="add-another-btn-div">
            <button id="add-another-btn" type="button"><i class="fas fa-plus-circle"></i> Add Another</button>
        </div>


        <div class="form-btn-div">
            <a class="previous-btn" href="/resume/section/heading">Previous</a>
            <button id="next-btn" type="button">Next</button>
        </div>
    </div>
    <div id="heading-preview">
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        let eduFormsContainer = document.getElementById('edu-forms-container');
        let addAnotherBtn = document.getElementById('add-another-btn');
        let submitBtn = document.getElementById('next-btn');

        submitBtn.addEventListener('click', cachedEduInfo);
        addAnotherBtn.addEventListener('click', insertEducationForm);

        // Function to set max end date for date inputs
        loadCached()
        function setMaxEndDate(form) {
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth() + 1).padStart(2, '0');
            let day = String(today.getDate()).padStart(2, '0');
            let todayDate = `${year}-${month}-${day}`;
            form.querySelector('input[name="end-date"]').setAttribute("max", todayDate);
        }


        setMaxEndDate(document.querySelector('.edu-form'));

        function removeEducationForm(eduFormWrapper) {
            let isConfirmed = confirm("Are you sure you want to delete this education entry?");

            if (!isConfirmed) {
                return
            }

            eduFormWrapper.classList.add('fade-out');
            setTimeout(() => {
                eduFormWrapper.remove();
            }, 300);
        }


        function insertEducationForm() {
            let eduFormWrapper = document.createElement('div');
            eduFormWrapper.classList.add('edu-form-wrapper');

            eduFormWrapper.innerHTML = `
            <form class="edu-form">
                <div>
                    <label for="degree">Degree</label>
                    <input type="text" name="degree" required>
                </div>

                <div>
                    <label for="school">Name of School/University</label>
                    <input type="text" name="school" required>
                </div>
                <div class="location-div">
                    <label for="location">Location</label>
                    <input type="text" name="location" required>
                </div>
                <div class="date-div">
                    <div>
                        <label for="start-date">Start Date</label>
                        <input type="date" name="start-date" required>
                    </div>

                    <div>
                        <label for="end-date">End Date</label>
                        <input type="date" name="end-date">
                    </div>

                    <input type="checkbox" name="is-working">
                    <label for="is-working">I haven't graduated</label>
                </div>
                <button type="button" class="remove-form-btn">Remove</button>
            </form>
            
        `;

            let removeBtn = eduFormWrapper.querySelector('.remove-form-btn');
            let eduForm = eduFormWrapper.querySelector('.edu-form');

            eduFormWrapper.addEventListener('mouseover', function () {
                removeBtn.classList.add('showed-remove-btn');
            });

            eduFormWrapper.addEventListener('mouseout', function () {
                removeBtn.classList.remove('showed-remove-btn');
            });

            removeBtn.addEventListener('click', () => removeEducationForm(eduFormWrapper));

            eduFormsContainer.appendChild(eduFormWrapper);

            setMaxEndDate(eduFormWrapper);
        }



        // Handle form submission


        function cachedEduInfo() {
            let eduForms = document.querySelectorAll('.edu-form');
            let educationData = [];

            eduForms.forEach(form => {
                let eduData = {
                    degree: form.querySelector('input[name="degree"]').value,
                    school: form.querySelector('input[name="school"]').value,
                    location: form.querySelector('input[name="location"]').value,
                    start_date: form.querySelector('input[name="start-date"]').value,
                    end_date: form.querySelector('input[name="end-date"]').value,
                    is_working: form.querySelector('input[name="is-working"]').checked
                };
                educationData.push(eduData);
            });

            localStorage.setItem('education_info', JSON.stringify(educationData));

            window.location.href = '/resume/section/work_experience';
        }


        function loadCached() {

            let cachedData = localStorage.getItem('education_info');

            if (cachedData) {
                let educationData = JSON.parse(cachedData);

                // Clear any existing forms in the container
                let eduFormsContainer = document.getElementById('edu-forms-container');
                eduFormsContainer.innerHTML = '';

                // Loop through the cached education data and create forms
                educationData.forEach(edu => {
                    let eduFormWrapper = document.createElement('div');
                    eduFormWrapper.classList.add('edu-form-wrapper');

                    eduFormWrapper.innerHTML = `
                    <form class="edu-form">
                        <div>
                            <label for="degree">Degree</label>
                            <input type="text" name="degree" value="${edu.degree}" required>
                        </div>
                        <div>
                            <label for="school">Name of School/University</label>
                            <input type="text" name="school" value="${edu.school}" required>
                        </div>
                        <div class="location-div">
                            <label for="location">Location</label>
                            <input type="text" name="location" value="${edu.location}" required>
                        </div>
                        <div class="date-div">
                            <div>
                                <label for="start-date">Start Date</label>
                                <input type="date" name="start-date" value="${edu.start_date}" required>
                            </div>
                            <div>
                                <label for="end-date">End Date</label>
                                <input type="date" name="end-date" value="${edu.end_date}">
                            </div>
                            <input type="checkbox" name="is-working" id="is-working" ${edu.is_working ? 'checked' : ''}>
                            <label for="is-working">I haven't graduated</label>
                        </div>
                        <button type="button" class="remove-form-btn">Remove</button>
                    </form>
                    `;

                    eduFormsContainer.appendChild(eduFormWrapper);

                    setMaxEndDate(eduFormWrapper);

                    let removeBtn = eduFormWrapper.querySelector('.remove-form-btn');
                    removeBtn.addEventListener('click', () => removeEducationForm(eduFormWrapper));

                    eduFormWrapper.addEventListener('mouseover', function () {
                        removeBtn.classList.add('showed-remove-btn');
                    });

                    eduFormWrapper.addEventListener('mouseout', function () {
                        removeBtn.classList.remove('showed-remove-btn');
                    });
                });
            }
        }

        // Call loadCached function on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadCached();
        });


    });
</script>

{% endblock %}